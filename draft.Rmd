---
title: Draft code and doc
---

# Let's get location

```r
#| load-pkg
library(pkgfilecache)
library(stringr)
library(dplyr)
library(tidyr)
library(purrr)
library(devtools)
devtools::load_all()
document()
test()

# optional
library(tibble)
```

```r
#| load-pkg
devtools::load_all()
document()
test()
```


```r
#| id: proto-function
list_optional_files()

op <- get_raw_operation_aspe() |> as_tibble()
ref_objective <- get_ref_objective_operation_aspe() |> as_tibble()
ref_protocol <- get_ref_protocol_operation_aspe() |> as_tibble()
op_objective <- get_objective_operation_aspe() |> as_tibble()
sampling_point <- get_sampling_point_aspe() |> as_tibble()
op_description <- get_description_operation_aspe() |> as_tibble()
ref_isolation <- get_ref_isolation_operation_aspe() |> as_tibble()

detail_sampling <- get_elementary_sampling_aspe() |> as_tibble()
ref_detail_sampling <- get_ref_elementary_sampling_aspe() |> as_tibble()
ref_prospection <- get_ref_prospection_method_operation_aspe() |> as_tibble()
ref_passage <- get_ref_passage_aspe() |> as_tibble()

point_group <- get_point_group_aspe() |> as_tibble()
ref_point_group <- get_ref_point_group_aspe() |> as_tibble()

species <- cleaning_species_ref_aspe() |> as_tibble()

ref_batch_type <- get_ref_type_batch_aspe() |> as_tibble()
raw_fish_batch <- get_fish_batch_aspe() |> as_tibble()
raw_individual_measurement <- get_individual_measurement_aspe() |> as_tibble()
```

```r
fish_batch <- clean_fish_batch(fish_batch = raw_fish_batch)
ind_measure <- clean_individual_measurement_aspe(
  ind_measure = raw_individual_measurement
)
```



```r
#| id: species
sp <- cleaning_species_ref_aspe() |> as_tibble()
```

```r
#| id: point-group
pt <- point_group %>%
  dplyr::left_join(ref_point_group) %>%
  dplyr::select(-grp_tgp_id) %>%
  dplyr::select(grp_id, point_type, everything())

cleaning_point_group() |> as_tibble()
cleaning_point_group() %>%
  filter(
    point_type == "standard_point" & grp_nombre_points_berge >= 0.90*(grp_nombre)
  )


````


```{r elementary-sampling}

ele_sampling <- cleaning_elementary_sampling() |> as_tibble()
ele_sampling %>%
  filter(is.na(passage_number))
```


```r
op_description <- clean_description_operation_aspe()  |> as_tibble()
# TODO:
# - Move and Document functions
# - Write some tests
# - Do we put it merge it with fish operation data? I think not for now
```


```r
sampling_point |>
  dplyr::filter(is.na(pop_sta_id))
op %>%
  dplyr::filter(is.na(pop_sta_id)) %>%
  select(date, obj_libelle, pro_libelle)

op_objective %<>%
  rename_with(., ~gsub("opo_", "", .x, fixed = TRUE)) %>%
  left_join(ref_objective) %>%
  select(ope_id, obj_libelle)

#We might want to check this more close when we have filtered the sites and
#the operations
op_objective %>%
  group_by(obj_libelle) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
  
```

```r
|# ref-protocol
ti <- op %>%
  left_join(ref_protocol, join_by(ope_pro_id == pro_id))
ti %>%
  group_by(pro_libelle) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
```



```r
op <- clean_operation_aspe() %>%
  as_tibble()

# TODO:
# - There is several operations, to see why
unique(op$operation_id) |> length()
nrow(op)
several_id <- op |>
  group_by(operation_id) |>
  summarise(n = n())
several_id |>
  filter(n > 1)
op |>
  filter(operation_id == 1579)

# It might be because of multiples ids per objective ids 
# Yes it is!!
op_objective <- get_objective_operation_aspe() |> as_tibble()
op_objective |>
  group_by(opo_ope_id) |>
  summarise(n = n()) |>
  filter(n > 1)

  filter(opo_ope_id)


```


```r
#TODO:
#- get the variables right: date, objective, protocols, etc...
#- Change/Translate the variable names
# We might want to remove operation with no objective?
  filter(is.na(obj_libelle))
#- Filter operation data so that they have only one objective
```


