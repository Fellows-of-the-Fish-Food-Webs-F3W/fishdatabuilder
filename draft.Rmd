---
title: Draft code and doc
---

# Let's get location

```r
#| load-pkg
library(pkgfilecache)
library(stringr)
library(dplyr)
library(tidyr)
library(purrr)
library(devtools)
build()
devtools::load_all()
document()
test()

sf::st_crs(3)$input
# optional
library(tibble)
```

```r
#| load-pkg
devtools::load_all()
document()
test()
```


```r
#| id: proto-function
list_optional_files()

op <- get_raw_operation_aspe() |> as_tibble()
ref_objective <- get_ref_objective_operation_aspe() |> as_tibble()
ref_protocol <- get_ref_protocol_operation_aspe() |> as_tibble()
op_objective <- get_objective_operation_aspe() |> as_tibble()
sampling_point <- get_sampling_point_aspe() |> as_tibble()
op_description <- get_description_operation_aspe() |> as_tibble()
ref_isolation <- get_ref_isolation_operation_aspe() |> as_tibble()
ref_prospection <- get_ref_prospection_method_operation_aspe() |> as_tibble()
```

```r

op_description <- clean_description_operation_aspe()  |> as_tibble()
# TODO: 
# - Move and Document functions
# - Write some tests
# - Do we put it merge it with fish operation data? I think not for now
```


```r
sampling_point |>
  dplyr::filter(is.na(pop_sta_id))
op %>%
  dplyr::filter(is.na(pop_sta_id)) %>%
  select(date, obj_libelle, pro_libelle)

op_objective %<>%
  rename_with(., ~gsub("opo_", "", .x, fixed = TRUE)) %>%
  left_join(ref_objective) %>%
  select(ope_id, obj_libelle)

#We might want to check this more close when we have filtered the sites and
#the operations
op_objective %>%
  group_by(obj_libelle) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
  
```

```r
|# ref-protocol
ti <- op %>%
  left_join(ref_protocol, join_by(ope_pro_id == pro_id))
ti %>%
  group_by(pro_libelle) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
```



```r
clean_operation_aspe <- function(
  op = get_raw_operation_aspe(),
  op_objective = get_objective_operation_aspe(),
  ref_objective = get_ref_objective_operation_aspe(),
  ref_protocol = get_ref_protocol_operation_aspe(), 
  sampling_point = get_sampling_point_aspe()
  ) {

  # Attach objective label to operation ids
  op_objective <- op_objective %>%
    dplyr::rename_with(., ~gsub("opo_", "", .x, fixed = TRUE)) %>%
    dplyr::left_join(ref_objective, dplyr::join_by(obj_id)) %>%
    dplyr::select(ope_id, obj_libelle)

  sampling_point <- sampling_point %>%
    dplyr::select(pop_id, pop_sta_id)

  # Translate protocol label into english
  ref_protocol <- ref_protocol %>%
    dplyr::mutate(pro_libelle = recode(pro_libelle,
      !!!get_rev_vec_name_val(replacement_operation_protocol_label())))

  # Get objectives and protocol labels + station id
  op <- op %>%
    dplyr::left_join(op_objective, dplyr::join_by(ope_id)) %>%
    dplyr::left_join(ref_protocol, dplyr::join_by(ope_pro_id == pro_id)) %>%
    dplyr::left_join(sampling_point, dplyr::join_by(ope_pop_id == pop_id)) %>%
    dplyr::rename_with(., ~gsub("ope_", "", .x, fixed = TRUE))

  # Select and remane columns
  op <- op %>%
    dplyr::select(all_of(replacement_operation_col())) %>%
    # without_fish variable into logical variable
    dplyr::mutate(
      without_fish = stringr::str_replace_all(
        without_fish,
        c("t" = "TRUE", "f" = "FALSE")
      ),
      without_fish = as.logical(without_fish)
    )
  # Add date in lubridate format
  op <- op %>%
    dplyr::mutate(
      date_time = lubridate::ymd_hms(date),
      date = lubridate::date(date_time)
    )
  # Add some info from desc table?
  op
}

op <- clean_operation_aspe() %>%
  as_tibble()

head(op$date)
library(lubridate)

```


```r
#TODO:
#- get the variables right: date, objective, protocols, etc...
#- Change/Translate the variable names
# We might want to remove operation with no objective?
  filter(is.na(obj_libelle))
```


